---
title: "Take Home Exercise 1"
author: "Eugene Toh"
date: "last-modified"
freeze: true
---

Geospatial analytics offer valuable insights into the patterns of armed conflict, enabling better understanding and response strategies. This study focuses on armed conflict events in Myanmar from January 2021 to June 2024, using data from the Armed Conflict Location & Event Data (ACLED) project. The analysis examines the spatial and temporal distribution of four key event types: Battles, Explosion/Remote Violence, Strategic Developments, and Violence Against Civilians. By investigating quarterly data, this study aims to reveal patterns in the conflict, contributing to a deeper understanding of the ongoing violence in Myanmar.

To start off, let's begin by importing all the necessary libraries:

```{r}
pacman::p_load(sf, tidyverse, tmap, spatstat, raster, sparr)
```

Now that we have done so, let's load the necessary combat data from ACLED (note that due to API limitations I am only able to get data from a certain starting date):

```{r}
conflict_data <- read_csv("data/2021-08-31-2024-06-30-Myanmar.csv")
```

```{r}
list(conflict_data)
```

We have the latitude and longitude of event locations. We need to convert them into SFOs such that we can work with them using the `sf` library. Additionally, we need to normalise the dates such that they are all standardised into the same format that is computer readable.

```{r}
conflict_data <- conflict_data %>% st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>% st_transform(crs = 32647) %>% mutate(event_date = dmy(event_date))
list(conflict_data)
```

Now that we have the armed conflict data, let's import the administrative boundary data:

```{r}
boundaries <- st_read("data", layer = "mmr_polbnda2_adm1_250k_mimu_1")
```

```{r}
st_crs(boundaries)
```

This is currently in WGS84, and we need to convert it into a projected coordinate system so we can work with the data.

```{r}
boundaries <- boundaries %>% st_transform(crs = 32647)
st_crs(boundaries)
```

A horrifying amount, most of which seems to be clustered at the interior of Myanmar. Let's overlay an administrative district map to see where most of them are all located at:

```{r}
tmap_mode('plot')
map1 <- tm_shape(boundaries) +
  tm_fill() +
  tm_borders() +
  tm_text("ST", size = 0.2, col = "blue")
map2 <- tm_shape(boundaries) +
  tm_fill() +
  tm_borders() +
  tm_shape(conflict_data) +
  tm_dots()
tmap_arrange(map1, map2, ncol = 2)
```

## Quarterly KDE analysis

Now we are going to apply Kernel Density Estimation (KDE) to conflict events for each quarter of the year. These layers show the density of events over a geographic area, which can help visualize how the concentration of those events changes over time, particularly on a quarterly basis. However, to do that we need to choose an appropriate year to observe the by-quarterly results. After much deliberation I have chose 2022 as the best year for this, and here's why:

-   The coup started in February 2021. While it might be interesting to analyse the slow growth in conflicts over time, the data is not representative of the Myanmar conflict as a whole.

-   In 2022, the political and military landscape had largely stabilized after the initial shock of the coup in 2021. The armed resistance led by various ethnic armed organizations (EAOs) and the People's Defense Forces (PDFs) was more organized and widespread.

### Data extraction and filtering

Extracting conflict data by quarter:

```{r}
conflict_data_2022_q1 <- conflict_data %>% filter(event_date >= as.Date("2022-01-01") & event_date <= as.Date("2022-03-31"))
conflict_data_2022_q2 <- conflict_data %>% filter(event_date >= as.Date("2022-04-01") & event_date <= as.Date("2022-06-30"))
conflict_data_2022_q3 <- conflict_data %>% filter(event_date >= as.Date("2022-07-01") & event_date <= as.Date("2022-09-30"))
conflict_data_2022_q4 <- conflict_data %>% filter(event_date >= as.Date("2022-10-01") & event_date <= as.Date("2022-12-31"))
```

### Data conversion

```         
::: {.callout-note}
The bandwidth in the context of KDE is a critical parameter that determines the level of smoothing applied to the data when estimating the density. It controls how much each data point influences the estimate of the density around it.
:::
```

```{r}
conflict_data_2022_q1_ppp <- as.ppp(conflict_data_2022_q1)
conflict_data_2022_q2_ppp <- as.ppp(conflict_data_2022_q2)
conflict_data_2022_q3_ppp <- as.ppp(conflict_data_2022_q3)
conflict_data_2022_q4_ppp <- as.ppp(conflict_data_2022_q4)
```

```{r}
plot(conflict_data_2022_q1_ppp)
```

```{r}
summary(conflict_data_2022_q1_ppp)
```

Many statistical methods in spatial point pattern analysis are based on the assumption that the underlying point process is simple. A simple point process means that no two points in the process can occupy the exact same location (i.e., they cannot be coincident).

If points are coincident, this assumption is violated, and the statistical methods that rely on this assumption may produce invalid or misleading results.

Thus, let's check if there are any duplicate points:

```{r}
any(duplicated(conflict_data_2022_q1_ppp))
any(duplicated(conflict_data_2022_q2_ppp))
any(duplicated(conflict_data_2022_q3_ppp))
any(duplicated(conflict_data_2022_q4_ppp))
```

As you can see, there doesn't seem to be any duplicated data points.

Next, we need to create an `owin` object. This helps to confine the analysis within a specific geographical area.

```{r}
boundaries_owin <- as.owin(boundaries)
```

```{r}
plot(boundaries_owin)
```

As, you can see, the `owin` object contains state boundaries, which we don't need. We need to find a way to dissolve those state boundaries.

```{r}
myanmar_sf <- st_union(boundaries)
```

```{r}
plot(myanmar_sf)
```

Still not that good. Luckily the website also contain geographical data that does not include state lines.

```{r}
national_boundaries <- st_read("data", layer = "mmr_polbnda_adm0_250k_mimu_1") %>% st_transform(crs = 32647)
st_crs(boundaries)
```

```{r}
national_boundaries_owin <- as.owin(national_boundaries)
```

```{r}
plot(national_boundaries_owin)
```

That's much better. We simply need to combine the `ppp` and the `owin` objects.

```{r}
conflictMYQ1_ppp <- conflict_data_2022_q1_ppp[national_boundaries_owin]
conflictMYQ2_ppp <- conflict_data_2022_q2_ppp[national_boundaries_owin]
conflictMYQ3_ppp <- conflict_data_2022_q3_ppp[national_boundaries_owin]
conflictMYQ4_ppp <- conflict_data_2022_q4_ppp[national_boundaries_owin]
```

```{r}
plot(conflictMYQ1_ppp)
```

```{r}
crs_info <- st_crs(national_boundaries)
unit_of_measurement <- crs_info$units
print(unit_of_measurement)
```

First, we need to convert the unit of measurement to kilometres since the density values would be too small to comprehend.

```{r}
conflictMYQ1_ppp.km <- rescale.ppp(conflictMYQ1_ppp, 1000, "km")
conflictMYQ2_ppp.km <- rescale.ppp(conflictMYQ2_ppp, 1000, "km")
conflictMYQ3_ppp.km <- rescale.ppp(conflictMYQ3_ppp, 1000, "km")
conflictMYQ4_ppp.km <- rescale.ppp(conflictMYQ4_ppp, 1000, "km")
```

### Working with different bandwidth methods

```{r}
bw.CvL(conflictMYQ1_ppp.km)
```

```{r}
bw.scott(conflictMYQ1_ppp.km)
```

```{r}
bw.ppl(conflictMYQ1_ppp.km)
```

```{r}
bw.diggle(conflictMYQ1_ppp.km)
```

The sigma values for `bw.diggle` and `bw.ppl` seem way too small. A small sigma value might result in sudden spikes of the data over an extremely small area, which would not be useful when analysing such a large geographical area. Since the conflict data contains regions where points seem to be highly clustered, an automatic bandwidth selection method might select a smaller `sigma` to capture the fine structure in those areas. This can lead to undersmoothing across the entire dataset, making the density plot appear as many small bright spots with abrupt transitions.

```{r}
kde_conflictMYQ1_scott <- density(conflictMYQ1_ppp.km, sigma=bw.scott, edge=TRUE, kernel="quartic")
kde_conflictMYQ1_CvL <- density(conflictMYQ1_ppp.km, sigma=bw.scott, edge=TRUE, kernel="quartic")
par(mfrow=c(1,2))
plot(kde_conflictMYQ1_scott, main = "bw.scott")
plot(kde_conflictMYQ1_CvL, main = "bw.CvL")
```

From trial and error, it seems like `bw.scott` is the best fit for our use case.

The `edge` parameter controls whether edge correction should be applied. Edge correction accounts for the fact that points near the boundaries of the observation window have fewer neighbors and, without correction, could lead to underestimation of density near the edges.Setting `edge = TRUE` ensures that edge correction is applied, which adjusts the density estimate near the borders to compensate for this bias.

To avoid negative intensity values, for kernel methods I will choose `"quartic"`.

### Plotting our results

Since we are analysing the same geographical area over a period of time, and we want to apply the same amount of smoothing, I am going to use the sigma value derived from the first quarter using `bw.scott` and apply it to all quarters.

```{r}
kde_sigma <- bw.scott(conflictMYQ1_ppp.km)
kde_conflictMYQ1.bw <- density(conflictMYQ1_ppp.km, sigma=kde_sigma, edge=TRUE, kernel="quartic")
kde_conflictMYQ2.bw <- density(conflictMYQ2_ppp.km, sigma=kde_sigma, edge=TRUE, kernel="quartic")
kde_conflictMYQ3.bw <- density(conflictMYQ3_ppp.km, sigma=kde_sigma, edge=TRUE, kernel="quartic")
kde_conflictMYQ4.bw <- density(conflictMYQ4_ppp.km, sigma=kde_sigma, edge=TRUE, kernel="quartic")
```

Next, I am going to convert this into a `raster` object to make it `ggplot2` compatible, to make it easier to plot with:

```{r}
kde_conflictMYQ1_raster <- raster(kde_conflictMYQ1.bw)
kde_conflictMYQ2_raster <- raster(kde_conflictMYQ2.bw)
kde_conflictMYQ3_raster <- raster(kde_conflictMYQ3.bw)
kde_conflictMYQ4_raster <- raster(kde_conflictMYQ4.bw)
```

Let us take a look at the properties of the `RasterLayer`s created.

```{r}
kde_conflictMYQ1_raster
```

Notice that the `crs` property is NA. We need to set it to an appropriate value.

```{r}
projection(kde_conflictMYQ1_raster) <- CRS("+init=EPSG:32647 +units=km")
projection(kde_conflictMYQ2_raster) <- CRS("+init=EPSG:32647 +units=km")
projection(kde_conflictMYQ3_raster) <- CRS("+init=EPSG:32647 +units=km")
projection(kde_conflictMYQ4_raster) <- CRS("+init=EPSG:32647 +units=km")
```

Now, it's finally time to plot the data.

#### 1st quarter

```{r}
tm_shape(kde_conflictMYQ1_raster) + 
  tm_raster("layer", palette = "viridis", title = "Conflict intensity", alpha = 0.7) +
  tm_layout(legend.position = c("left", "bottom"), frame = FALSE) +
  tm_shape(boundaries) +
  tm_text("ST", size = 0.3, col = "white")
```

The map reveals that much of the conflict occurred in Sagaing and Magway, with localized fighting in Shan (South) and Kayah, and another significant hotspot in Yangon. This aligns with news reports indicating that during the first quarter of 2022, the Myanmar conflict was primarily concentrated in Rakhine, Chin, Sagaing, and Magway regions. Sagaing and Magway, in particular, saw numerous battles involving the People’s Defence Forces (PDF), while Chin State experienced substantial conflict due to its proximity to India and the presence of active ethnic insurgent groups. Meanwhile, Rakhine State remained a key battleground for clashes between the Arakan Army (AA) and the Tatmadaw.

Sagaing and Magway became strongholds for the PDF, local militias that formed in response to the military coup. These regions saw widespread opposition to military rule, with strong support for the armed struggle against the Tatmadaw. The terrain in Sagaing, in particular, provided resistance groups with strategic advantages for carrying out guerrilla-style attacks on military convoys and outposts.

Yangon, Myanmar’s largest city, also became a significant hotspot during this period. While most rural areas were engulfed in insurgency and military battles, urban resistance in Yangon consisted of sabotage operations, targeted assassinations, and bombings orchestrated by the PDF and other resistance groups. These attacks targeted military personnel, government officials, and infrastructure, making Yangon a focal point of urban conflict.

In Shan (South) and Kayah, localized conflicts arose due to territorial disputes and long-standing tensions. Both regions are home to multiple ethnic armed groups, and the fighting reflected ongoing struggles for control and autonomy in the area.

#### 2nd quarter

```{r}
tm_shape(kde_conflictMYQ2_raster) + 
  tm_raster("layer", palette = "viridis", title = "Conflict intensity", alpha = 0.7) +
  tm_layout(legend.position = c("left", "bottom"), frame = FALSE) +
  tm_shape(boundaries) +
  tm_text("ST", size = 0.3, col = "white")
```

In the second quarter, fighting became more concentrated in Sagaing, Magway, and Chin State. In particular, the conflict in Chin State intensified as clashes escalated between the Tatmadaw and ethnic insurgent groups, including the Chin National Front (CNF) and local PDF forces. Chin State's strategic location near the Indian border made it a key theater of conflict, prompting increased military offensives against insurgent strongholds. This led to more intense military operations and a rise in human rights abuses, such as arbitrary detentions and targeted attacks on civilians.

Meanwhile, conflict in Shan (South)/Kayah and Yangon showed signs of abating. The Tatmadaw redirected its focus to the more intense fighting in Sagaing, Magway, and Chin, which had become central battlegrounds due to the growing strength of the PDF. This shift likely reduced military pressure in Shan (South) and Kayah, contributing to the decline in conflict there. Additionally, reports of temporary ceasefires or negotiation efforts between the Tatmadaw and some ethnic armed organizations (EAOs) may have contributed to the decrease in reported conflicts, although these ceasefires are often fragile.

Tanintharyi experienced a rise in reported conflicts during the second quarter. Previously, this southern Myanmar region had been relatively less impacted by the conflict, but by quarter 2, it saw increased activity due to escalating resistance from local People's Defence Forces (PDF) and clashes with the military. The region's strategic coastal position and its proximity to Thailand likely played a role in its growing importance in the conflict.

#### 3rd quarter

```{r}
tm_shape(kde_conflictMYQ3_raster) + 
  tm_raster("layer", palette = "viridis", title = "Conflict intensity", alpha = 0.7) +
  tm_layout(legend.position = c("left", "bottom"), frame = FALSE) +
  tm_shape(boundaries) +
  tm_text("ST", size = 0.3, col = "white")
```

Between quarters 2 and 3, the conflict in Shan (South) and Kayah significantly decreased, while fighting in Yangon returned to the intensity seen in quarter 1. The People's Defence Forces (PDF) and other resistance groups likely resumed urban operations, including sabotage, bombings, and targeted assassinations, directed at military personnel and government officials. This resurgence indicates a renewal of urban resistance despite heightened military crackdowns. Meanwhile, Rakhine State experienced a sharp rise in reported conflicts. The Arakan Army (AA) intensified its efforts against the Tatmadaw, seeking greater control over the region. The AA's renewed activity led to more frequent clashes, with the fighting spreading to more densely populated areas, worsening the humanitarian crisis.

#### 4th quarter

```{r}
tm_shape(kde_conflictMYQ4_raster) + 
  tm_raster("layer", palette = "viridis", title = "Conflict intensity", alpha = 0.7) +
  tm_layout(legend.position = c("left", "bottom"), frame = FALSE) +
  tm_shape(boundaries) +
  tm_text("ST", size = 0.3, col = "white")
```

In quarter 4, fighting became more localized in Sagaing, while conflict in Chin State subsided. However, hostilities persisted in Rakhine, Yangon, and Tanintharyi.

In Sagaing, the fighting intensified and became more concentrated, likely due to the Tatmadaw’s increased efforts to suppress resistance forces, particularly in rural areas where the People's Defence Forces (PDF) operated. The region’s terrain, which is conducive to guerrilla tactics, allowed resistance groups to continue their operations, despite the fighting being confined to specific pockets. The Tatmadaw may have redirected more resources to Sagaing, leading to a reduction in larger-scale battles elsewhere.

Earlier in the year, Chin State had experienced heavy fighting, but by quarter 4, both sides may have been experiencing resource exhaustion, resulting in a relative lull in conflict. The state’s terrain and its cross-border dynamics with India may have also contributed to the decrease in confrontations.

Rakhine State remained a key battleground, with ongoing clashes between the Arakan Army (AA) and the Tatmadaw. The AA’s growing strength and territorial ambitions fueled the conflict as they sought greater autonomy for the region. The Tatmadaw likely prioritized Rakhine due to its strategic importance along the Bay of Bengal.

Tanintharyi continued to witness fighting, largely due to its strategic location and the rising presence of resistance groups. Its proximity to the Thai border made the region a crucial area for supply routes and safe havens for resistance forces, resulting in sustained military clashes.

#### Summary

```{r}
#| fig-width: 12
#| fig-height: 10
#| eval: false
pacman::p_load(gifski)
q1_graph <- tm_shape(kde_conflictMYQ1_raster) + 
  tm_raster("layer", palette = "viridis", title = "Conflict intensity", alpha = 0.7) +
  tm_layout(legend.position = c("left", "bottom"), frame = FALSE, main.title = "Conflict Intensity - Q1") +
  tm_shape(boundaries) +
  tm_text("ST", col = "white")
q2_graph <- tm_shape(kde_conflictMYQ2_raster) + 
  tm_raster("layer", palette = "viridis", title = "Conflict intensity", alpha = 0.7) +
  tm_layout(legend.position = c("left", "bottom"), frame = FALSE, main.title = "Conflict Intensity - Q2") +
  tm_shape(boundaries) +
  tm_text("ST", col = "white")
q3_graph <- tm_shape(kde_conflictMYQ3_raster) + 
  tm_raster("layer", palette = "viridis", title = "Conflict intensity", alpha = 0.7) +
  tm_layout(legend.position = c("left", "bottom"), frame = FALSE, main.title = "Conflict Intensity - Q3") +
  tm_shape(boundaries) +
  tm_text("ST", col = "white")
q4_graph <- tm_shape(kde_conflictMYQ4_raster) + 
  tm_raster("layer", palette = "viridis", title = "Conflict intensity", alpha = 0.7) +
  tm_layout(legend.position = c("left", "bottom"), frame = FALSE, main.title = "Conflict Intensity - Q4") +
  tm_shape(boundaries) +
  tm_text("ST", col = "white")
tmap_animation(
  list(q1_graph, q2_graph, q3_graph, q4_graph),
  delay = 100,
  filename = "raster_animation.gif",
  width = 1080,
  height = 1920
)
```

![Conflict Intensity Animation](raster_animation.gif)

Since all the raster's represent the same area in different periods of time, we are going to create a `RasterStack` to visualise the conflict over an OpenStreetMap view with `tmap`.

```{r}
conflictMY_raster <- stack(kde_conflictMYQ1_raster, kde_conflictMYQ2_raster, kde_conflictMYQ3_raster, kde_conflictMYQ4_raster)
class(conflictMY_raster)
```

```{r}
#| fig-width: 12
#| fig-height: 10
tmap_mode("view")
tm_shape(conflictMY_raster) + 
  tm_raster("layer", palette = "viridis", title = "Conflict intensity", alpha = 0.7) +
  tm_basemap("OpenStreetMap") +
  tm_layout(legend.position = c("left", "bottom"), frame = FALSE)
tmap_mode("plot")
```

### Is the conflict clustered or dispersed?

We can use Clark-Evans test to test for whether the distribution of conflicts is clustered or dispersed across Myanmar. This can help us understand the underlying patterns and drivers of conflict. If the conflict events are clustered in specific areas, it suggests the presence of hotspots driven by factors such as ethnic tensions, military strategies, or geographical advantages.

Since I am coming in with the notion that the distribution of conflicts are highly clustered. I am going to use a one-tailed Clark-Evans test. I am however not going to use edge correction for my test, as I personally feel that the study area is large enough that it is not sufficient to result in fewer neighbours along the boundaries. In fact, data so far has shown that that is in fact the opposite. Fighting seemed more intense in areas bordering India and Thailand.

The test hypotheses are:

Ho = The distribution of conflicts are randomly distributed (complete spatial randomness when R = 1).

H1= The distribution of conflicts are not randomly distributed (the events are clustered and closer together than expected under random distribution when R \< 1).

The 95% confident interval will be used.

```{r}
conflictMY_ppp <- superimpose(conflictMYQ1_ppp, conflictMYQ2_ppp, conflictMYQ3_ppp, conflictMYQ4_ppp)
```

```{r}
clarkevans.test(conflictMY_ppp,
                correction="none",
                clipregion="national_boundaries_owin",
                alternative=c("clustered"),
                nsim=99)
```

Since our R-value is less than 1, it indicates clustering. In this case, R = 0.16171, which is significantly less than 1, indicating that the conflicts are clustered.

The p-value represents the probability of observing such a clustered pattern under the null hypothesis of randomness. A p-value less than the significance level (α = 0.05) allows us to reject the null hypothesis. In this case, the p-value is extremely small (essentially zero), far below the 0.05 threshold.

Since R \< 1 and the p-value is extremely small, we reject the null hypothesis.

This means we have strong evidence to conclude that the distribution of conflicts is not randomly distributed. Instead, the distribution is clustered. Conflicts tend to be closer together than what would be expected under a random spatial distribution.

## 2nd-order Spatial Point Patterns Analysis

To do our 2nd order spatial point analysis, let's focus on the Sagaing, the state where the conflicts was the most fiercest in 2022.

```{r}
conflict_data_2022_sagaing <- conflict_data %>% filter(admin1 == "Sagaing") %>% filter(year == 2022)
conflict_data_2022_sagaing_ppp <- as.ppp(conflict_data_2022_sagaing)
```

```{r}
unitname(conflict_data_2022_sagaing_ppp)
```

The unit of the `ppp` function has not been set. Let's set it to metres based on the CRS.

```{r}
unitname(conflict_data_2022_sagaing_ppp) <- c("metre", "metres")
```

### F-Function

The F function estimates the empty space function F(r) or its hazard rate h(r) from a point pattern in a window of arbitrary shape.

The F-function measures the cumulative distribution of distances from a random point in the study region to the nearest point in the point pattern. Essentially, it answers the question: "given a random location in the study area, what is the probability that the nearest point in the pattern is within a distance `r`"?

-   **x-axis (r):** Represents the distance from a random point in the study area to the nearest point in the pattern.

-   **y-axis (F(r)):** Represents the cumulative probability that the distance from a random location to the nearest point is less than or equal to `r`.

```{r}
F_Sagaing = Fest(conflict_data_2022_sagaing_ppp)
plot(F_Sagaing)
```

-   The solid line represents the empirical F-function (`F(r)`), which shows the distribution of distances from random points in the study area to the nearest observed point.

-   The dashed line represents the theoretical F-function under complete spatial randomness (CSR). This line helps you compare the observed point pattern to a random point distribution.

The small gradient in the F-function at short distances suggests that many random locations in the study area have no nearby conflict events. This implies that conflict events are sparse or dispersed at smaller scales.

Around the 2000-meter mark, the F-function shows a more linear increase, indicating that random locations start to have a consistent distance to the nearest conflict event. Beyond this point, events are regularly spaced, implying a more uniform distribution.

The initial slow rise suggests conflict events are far from random locations at small scales, while the linear rise beyond 2000 meters points to a consistent spacing pattern. This may reflect conflict clustering in specific areas, with gaps between them, and more predictable event proximity at larger distances.

Conflict events may be concentrated in specific areas like towns, military bases, or strategic locations, with gaps in between, resulting in regular spacing at a larger scale. At shorter distances, fewer events occur, indicating less frequent conflict, but beyond around 2000 meters, events become more consistently distributed.

#### Hypothesis testing

To confirm the observed spatial patterns above, a hypothesis test will be conducted. The hypothesis and test are as follows:

Ho = The distribution of conflicts at Sagaing are randomly distributed.

H1= The distribution of conflicts at Sagaing are not randomly distributed.

The null hypothesis will be rejected if p-value is smaller than alpha value of 0.001.

```{r}
F_Sagaing.csr <- envelope(conflict_data_2022_sagaing_ppp, Fest, nsim = 999)
```

```{r}
plot(F_Sagaing.csr)
```

### L-Function

The K-function measures the number of events found up to a given distance of any particular event.

It answers the question: "how many additional points are found within a distance `r` from an average point, compared to what would be expected if the points were randomly distributed"?

The L-function is a transformation of the K-function designed to make it easier to interpret the results of spatial point pattern analysis. The L-function is often used because it linearizes the K-function under the assumption of complete spatial randomness (CSR), making deviations from randomness easier to detect.

**Linear Under CSR:** Under complete spatial randomness (CSR), the L-function should be approximately equal to the distance `r`.

-   **Clustering:** If the observed is above the line, it indicates clustering at distance `r`. There are more points close to each other than expected under CSR.

-   **Dispersion:** If the observed is below the line, it indicates regularity or dispersion at distance `r`. The points are more evenly spaced than expected under CSR.

```{r}
L_ck = Lest(conflict_data_2022_sagaing_ppp, correction = "Ripley")
plot(L_ck, . -r ~ r, 
     ylab= "L(d)-r", xlab = "d(m)", xlim=c(0,50000))
```

The decrease in the K-function up to 5000 meters suggests point dispersion at smaller distances. The sharp increase at 5000 meters indicates the start of clustering, with local clusters becoming more apparent. The gradual rise between 5000 and 25000 meters reflects increasing clustering across larger areas, possibly indicating regional-scale grouping of points, like towns or strategic locations. The second sharp increase at 25,000 meters suggests larger clusters or groups of clusters, indicating broader patterns in how the points are distributed. Beyond 25,000 meters, clustering continues across even larger distances, pointing to an overall structure where points are organized into regional clusters. Beyond 25000 meters, clustering continues across even larger distances, pointing to an overall structure where points are organized into regional clusters.

The regular spacing up to 5000 meters could be due to geographic barriers or strategic factors preventing clustering. The sharp increase at 5000 meters suggests localized clusters, possibly in towns or military zones, while the second increase at 25000 meters reflects a larger, regional-scale clustering. Beyond 25000 meters, the upward trend indicates that these clusters are part of a broader pattern, with conflict events in different regions still showing interdependence over larger distances.

#### Hypothesis testing

To confirm the observed spatial patterns above, a hypothesis test will be conducted. The hypothesis and test are as follows:

Ho = The distribution of conflicts at Sagaing are randomly distributed.

H1= The distribution of conflicts at Sagaing are not randomly distributed.

The null hypothesis will be rejected if p-value if smaller than alpha value of 0.001.

```{r}
L_Sagaing.csr <- envelope(conflict_data_2022_sagaing_ppp, Lest, nsim = 99, rank = 1, glocal=TRUE)
```

```{r}
plot(L_Sagaing.csr, . - r ~ r, xlab="d", ylab="L(d)-r", xlim=c(0,50000))
```

## Quarterly spatio-temporal KDE

A spatio-temporal point process (also called space-time or spatial-temporal point process) is a random collection of points, where each point represents the time and location of an event. In this section, we are going to take a deep dive into the conflict occurring at Sagaing.

### Import data

```{r}
townships <- st_read("data", layer = "mmr_polbnda_adm3_250k_mimu_1") %>% st_transform(crs = 32647) %>% filter(ST == "Sagaing")
```

### Plotting out maps

Now, we need to extract out the month from the dates in each conflict and transform it into yearly quarters (from 1 to 4). Take note that we define a custom function called `get_quarter` to make our lives easier. We then only select out the quarter and the geometry to make quarter the marks value for the `as.ppp` function to interpret the data correctly.

```{r}
get_quarter <- function(month) {
  return ((month + 2) %/% 3)
}

conflict_quarter <- conflict_data_2022_sagaing %>% mutate(quarter = month(event_date) %>% get_quarter()) %>% dplyr::select(quarter)
```

#### Creating `owin` object

We first convert the `conflict_quarter` dataset into a `ppp` using the `as.ppp` function. The `ppp` object represents a point pattern, which includes the locations of conflict events and which quarter each conflict took place. We then convert the `townships` dataset into an observation window (owin) using the `as.owin` function. An `owin` object defines a spatial window, i.e., the region of interest where spatial analysis is performed (in this case, the township boundaries).

```{r}
conflict_quarter_ppp <- rescale(as.ppp(conflict_quarter), s = 1000, unitname = c("km", "kilometers"))
townships_owin <- rescale(as.owin(townships), s = 1000, unitname = c("km", "kilometers"))
combined_owin <- conflict_quarter_ppp[townships_owin]
```

#### Calculating STKDE

We then use `spattemp.density` from the `sparr` library to perform a **spatio-temporal kernel density estimation** (KDE). This would estimate how the density of the events (like conflicts) changes over both space and time, smoothing the point pattern (`combined_owin`) using a kernel function.

```{r}
st_kde <- spattemp.density(combined_owin)
```

#### Plotting the results

We then create a multi-panel plot layout and visualise spatio-temporal kernel density estimation (KDE) results across different time intervals, while overlaying township boundaries and labeling them on each plot. This allows us to better analyse conflict hotspots in detail.

```{r}
#| fig-width: 12
#| fig-height: 10
# Convert townships to sf object (if not already in sf format)
townships_sf <- st_as_sf(townships)

# Set tmap mode to "view" to display interactive maps in Quarto
tmap_mode("view")

# Loop through the quarters and display KDE for each time slice
tims <- 1:4  # Time indices corresponding to each quarter
for (i in tims) {
  
  # Extract the spatial KDE slice for the i-th quarter
  kde_slice <- st_kde$z[[i]]  # Assuming st_kde has a list of rasters for each time step
  
  # Convert KDE slice to RasterLayer
  kde_raster <- raster(kde_slice)
  
  # Ensure the raster has correct extent and CRS
  extent(kde_raster) <- st_bbox(townships_sf)  # Set bounding box to match townships
  crs(kde_raster) <- st_crs(townships_sf)$proj4string  # Match CRS
  
  # Create the tmap plot
  tm <- tm_shape(kde_raster) +
    tm_raster("layer", title = paste("KDE at quarter", i), style = "cont", legend.show = TRUE, alpha = 0.7) +  # KDE layer
    
    # Add township borders
    tm_shape(townships_sf) + 
    tm_borders(col = "black", lwd = 1) + 
    
    # Add township labels at centroids
    tm_text("TS", size = 0.5, col = "blue") +
    
    # Overlay OpenStreetMap as the basemap
    tm_basemap(server = "OpenStreetMap") + 
    
    # Layout settings
    tm_layout(main.title = paste("KDE at quarter", i), legend.outside = TRUE)
  
  # Print the map to display it in Quarto
  print(tm)
}
tmap_mode("plot")
```

In quarter 1, conflict is mainly situated around the township of Salingyi, with smaller pockets around Kale and at the meeting point of Tabayin and Khin-U. Salingyi is home to the controversial Letpadaung copper mine, a frequent site of protests and conflict due to land disputes and environmental issues. Its economic significance and military ties make it a target for insurgents. Sagaing has been a key resistance area against the military junta, especially after the 2021 coup, with People's Defense Forces (PDFs) and ethnic armed groups active in the region. Kale and the Tabayin-Khin-U area are known resistance centers, with smaller conflicts likely linked to local PDFs and clashes with military forces.

Sagaing Region, largely Bamar, borders Chin and Shan states, contributing to tensions from neighboring ethnic conflicts. Local grievances, like land rights issues, may have fueled resistance in Salingyi, while the Tabayin-Khin-U area is strategic for transportation routes, crucial for both the military and insurgents. Sagaing’s terrain favors insurgents, allowing for sustained clashes, especially near Kale, close to Chin State's conflict zones. The Myanmar military likely targeted these areas due to their strategic importance and the presence of resistance forces.

In quarter 2, conflict around the Tabayin-Khin-U region died down. In quarter 3, the conflict at Kale and Salingyi seems to be dying down, but in quarter 4 it flared back up again, but thankfully we have not seen a dramatic resurgance at Kale. Smaller scale conflicts have also started to flare up around Sagaing and Wetlet townships. In Sagaing and Wetlet townships, smaller-scale conflicts suggest the spread of insurgency tactics. Mobile groups of PDFs may be using hit-and-run tactics or localized skirmishes, particularly where the military is stretched thin. Resistance forces could be shifting to smaller engagements across a broader area, targeting government forces or infrastructure.

### Animating the conflict in Sagaing for 2022

Just for curiosity's sake, we are also going to analyse the trajectory of the conflict in detail via an animation by bringing in the `animation` library which creates a GIF and embeds it on this HTML page.

We are going to extract the week number for each conflict from 1 to 52 (2022 is not a leap year so it is not 53). We then only select the week and the geometry in the SFO such that it will choose the correct marks value. Next, we convert it first to a `ppp` object and then to an `owin` object as per usual. We combine the points and the geometry, calculate STKDE, and plot a separate graph for each week.

The reason why I used weeks and not days is that the data we have does not track how long a conflict occurs. Hence according to our maps, a conflict could be reported one day and gone at the next, which could be misleading. Using weeks instead of days makes it less granular.

Note that `eval` is set to `false` since `saveGIF` requires the `imagemagick` system library and not every computer has it installed.

```{r}
#| eval: false
pacman::p_load(animation)
conflict_week <- conflict_data_2022_sagaing %>% mutate(week = week(event_date)) %>% dplyr::select(week)
conflict_week_ppp <- as.ppp(conflict_week)
townships_owin <- as.owin(townships)
combined_owin <- conflict_week_ppp[townships_owin]
st_kde <- spattemp.density(combined_owin)
saveGIF({
  tims <- 1:52
  for(i in tims){
    plot(st_kde, i, override.par=FALSE, fix.range=TRUE, main=paste("KDE at week",i))
    plot(st_geometry(townships), add=TRUE)
    text(st_coordinates(suppressWarnings(st_centroid(townships))), labels=townships$TS, col="white")
}
}, movie.name = "myanmar_conflict.gif", interval = 0.5, nmax = 30, ani.width = 1920, ani.height = 1080)
```

![Myanmar Conflict Animation](myanmar_conflict.gif)

## 2nd Order Spatio-temporal Point Patterns Analysis

Now let's shift our attention to Yangon. Yangon is the largest city in Myanmar and it would be interesting to find out the relationship between the road networks in the city and conflict events. We could have also chosen to analyse river or railway networks in Yangon, but I personally feel that there is not enough of them to give us an accurate representation.

```{r}
yangon_bounds <- boundaries %>% filter(ST == "Yangon")
railways <- st_read("data", layer = "mmr_rlwl_250k_mimu_1") %>% st_transform(crs = 32647) %>% filter(Div_Name == "Yangon")
railways <- st_intersection(railways, yangon_bounds) %>% st_cast("LINESTRING")
rivers <- st_read("data", layer = "myanmar_river_network_250k") %>% st_transform(crs = 32647)
rivers <- st_intersection(rivers, yangon_bounds) %>% st_cast("LINESTRING")
tmap_mode("view")
tm_shape(rivers) +
  tm_lines()
tm_shape(railways) +
  tm_lines()
tmap_mode("plot")
```

### Importing data

```{r}
yangon_bounds <- boundaries %>% filter(ST == "Yangon")
class(yangon_bounds)
```

Now let's bring in an extra dependency, `spNetwork` which is going to help us calculate network KDE.

Network KDE (NKDE) is essentially a variation of KDE that applies to events occuring alongside networks like roads or railways. With NKDE, we can calculate and visualise the density of events happening right alongside networks.

```{r}
pacman::p_load(spNetwork)
```

### Data importing

Now that we are done with the import, we are going to filter conflict data to look for conflicts that happened in 2022 and in Yangon.

```{r}
conflict_data_2022 <- conflict_data %>% filter(year == 2022 & admin1 == "Yangon")
```

Now that we have conflict points, let's bring in the road network data.

```{r}
roads <- st_read("data", layer = "mmr_rdsl_mimu_250k") %>% st_transform(crs = 32647)
```

Notice that we are casting each row to a `LineString`. This is going to be important later on as we cannot directly work with `MultiLineString`s which is what the Shapefile gives us.

### Data wrangling

Notice that we have imported the road network for the entire Myanmar. To keep it within Yangon, we are going to use `st_intersection` to chop off any parts of the road that is not within the state.

```{r}
roads <- st_intersection(roads, yangon_bounds)
glimpse(st_geometry(roads))
```

Just by using `st_intersection`, we get back an `sfc_GEOMETRY` object (we get a mix of `MultiLineString`s and `LineString`s), while what we want is `sfc_LINESTRING`.

```{r}
roads <- roads %>% st_cast("LINESTRING")
class(st_geometry(roads))
```

### Calculating NKDE

We first have to calculate lixels and samples.

What are lixels? Well, you can think of lixels as individual segments of a line of fixed length. It is useful for calculating density estimation along a network. This together with samples, which represent locations where the kernel density is calculated can give us a nice visualisation of density along a network.

```{r}
lixels_roads <- lixelize_lines(roads, 700, mindist = 375)
samples_roads <- lines_center(lixels_roads)
```

There are many knobs we can configure here, but let's talk about one of the most important aspects, the method.

```{r}
densities_roads <- nkde(roads, 
                  events = conflict_data_2022,
                  w = rep(1, nrow(conflict_data_2022)),
                  samples = samples_roads,
                  kernel_name = "quartic",
                  bw = 300, 
                  div= "bw", 
                  method = "simple", 
                  digits = 1, 
                  tol = 1,
                  grid_shape = c(1,1), 
                  max_depth = 8,
                  agg = 5, 
                  sparse = TRUE,
                  verbose = FALSE)
```

Now, we need to scale the density in such a way that it can be rendered by `tmap`.

```{r}
samples_roads$density <- densities_roads
lixels_roads$density <- densities_roads
samples_roads$density <- samples_roads$density * 1000
lixels_roads$density <- lixels_roads$density * 1000
```

```{r}
tmap_mode('view')
tm_shape(lixels_roads)+
  tm_lines(col="density")+
tm_shape(conflict_data_2022)+
  tm_dots()
tmap_mode('plot')
```

As you can see, the main cluster of conflicts occur at Downtown Yangon. Many of these conflicts were triggered by homemade explosives made by guerrilla groups. As urban warfare became impractical, resistance forces shifted to targeting SAC-aligned officials, with 367 SAC-appointed officials assassinated between February 2021 and February 2022. Resistance also targeted the homes of SAC pilots in Yangon in retaliation for airstrikes on civilians. In September 2022, anti-SAC guerillas assassinated retired Brigadier General Ohn Thwin, mentor to SAC vice-chairman Soe Win, prompting increased security for top SAC officials.

```{r}
tmap_mode('view')
tm_shape(conflict_data_2022) +
  tm_dots(col = "sub_event_type",
          palette = "Set1",
          size = 0.1,
          title = "Conflict Types") +
tm_shape(roads) +
  tm_lines()
tmap_mode("plot")
```

There is a huge cluster of conflicts in Downtown Yangon corresponding with remove explosives or IEDs. There is also a tinier cluster of arrests west of Yangon. On 31 May 2022, a bombing near Sule Pagoda in Yangon killed one and injured nine. State media blamed the People's Defence Force, which denied involvement.

## Conclusion

The geospatial analysis of the Myanmar conflict from January 2021 to June 2024 reveals key patterns in the distribution of violence. Focusing on Battles, Explosion/Remote violence, Strategic developments, and Violence against civilians, Kernel Density Estimation (KDE) highlighted intense conflict clustering in Rakhine, Chin, Sagaing, and Kayah states.

While regions like Yangon and Shan (South)/Kayah experienced temporary reductions in violence, they saw a resurgence in later periods. The conflict's spread into Tanintharyi and Sagaing suggests an escalation into previously less-affected areas. Yangon saw sporadic but notable bursts of violence, reflecting evolving urban warfare and insurgent tactics.

Overall, the spatial analysis underscores the complexity of the conflict, with violence intensifying in certain areas while abating in others. The regional variation in conflict dynamics highlights the importance of localized peacebuilding efforts and strategic responses tailored to each area’s unique conflict drivers. The results provide valuable insights into how the conflict is evolving and the geographic factors influencing its trajectory, offering a foundation for more targeted humanitarian interventions, security responses, and conflict resolution efforts in Myanmar.
